<!DOCTYPE html><html class="default" lang="en"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>@rvohealth/dream</title><meta name="description" content="Documentation for @rvohealth/dream"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script defer src="assets/main.js"></script><script async src="assets/icons.js" id="tsd-icons-script"></script><script async src="assets/search.js" id="tsd-search-script"></script><script async src="assets/navigation.js" id="tsd-nav-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search" data-base="."><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">@rvohealth/dream</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><h2>@rvohealth/dream</h2></div><div class="tsd-panel tsd-typography"><a id="md:dream-orm" class="tsd-anchor"></a><h1 class="tsd-anchor-link">dream ORM<a href="#md:dream-orm" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h1><p>The dream ORM is an ORM inspired heavily by the <a href="https://guides.rubyonrails.org/active_record_querying.html">Ruby on Rails Active Record</a> pattern, and was designed predominantly as a tool to help migrate PlateJoy's app ecosystem from ruby to node. In the search for a comprehensive ORM in node that maintains the depth and necessary features provided by rails, we have decided to write our own, written on a <a href="https://github.com/kysely-org/kysely">very powerful, safely type-guarded query builder called kysely</a>.</p>
<p>Using this library as our query building engine, we have stacked a comprehensive ORM layer on top to provide a rich set of features, of which will be predominantly used in the psychic web framework, also being developed and inspired by the Ruby on Rails web framework.</p>
<a id="md:getting-started" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Getting started<a href="#md:getting-started" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><a id="md:install-nodenv" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Install <code>nodenv</code><a href="#md:install-nodenv" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>In order to use dream, you must be using node = 18.15.0. A <code>.node-version</code> file exists at the root of this repo to flag the node version, but it will not work unless <code>nodenv</code> has been correctly installed on your machine.</p>
<a id="md:add-env-files" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Add ENV files<a href="#md:add-env-files" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>make sure to add the following files to the root of the project:</p>
<pre><code><span class="hl-0"># .</span><span class="hl-1">env</span><br/><span class="hl-2">DREAM_CORE_DEVELOPMENT</span><span class="hl-0">=</span><span class="hl-3">1</span><br/><span class="hl-2">DB_USER</span><span class="hl-0">=</span><span class="hl-2">YOUR_PG_USERNAME</span><br/><span class="hl-2">DB_NAME</span><span class="hl-0">=</span><span class="hl-1">dream_core_dev</span><br/><span class="hl-2">DB_PORT</span><span class="hl-0">=</span><span class="hl-3">5432</span><br/><span class="hl-2">DB_HOST</span><span class="hl-0">=</span><span class="hl-1">localhost</span>
</code><button>Copy</button></pre>

<pre><code><span class="hl-0"># .</span><span class="hl-1">env</span><span class="hl-0">.</span><span class="hl-1">test</span><br/><span class="hl-2">DREAM_CORE_DEVELOPMENT</span><span class="hl-0">=</span><span class="hl-3">1</span><br/><span class="hl-2">DB_USER</span><span class="hl-0">=</span><span class="hl-2">YOUR_PG_USERNAME</span><br/><span class="hl-2">DB_NAME</span><span class="hl-0">=</span><span class="hl-1">dream_core_test</span><br/><span class="hl-2">DB_PORT</span><span class="hl-0">=</span><span class="hl-3">5432</span><br/><span class="hl-2">DB_HOST</span><span class="hl-0">=</span><span class="hl-1">localhost</span>
</code><button>Copy</button></pre>

<a id="md:build-db-and-sync-schema" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Build db and sync schema<a href="#md:build-db-and-sync-schema" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="bash"><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">install</span><br/><span class="hl-1">NODE_ENV</span><span class="hl-0">=</span><span class="hl-5">development</span><span class="hl-0"> </span><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">dreamcore</span><span class="hl-0"> </span><span class="hl-5">db:create</span><br/><span class="hl-1">NODE_ENV</span><span class="hl-0">=</span><span class="hl-5">development</span><span class="hl-0"> </span><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">dreamcore</span><span class="hl-0"> </span><span class="hl-5">db:migrate</span><br/><span class="hl-1">NODE_ENV</span><span class="hl-0">=</span><span class="hl-5">test</span><span class="hl-0"> </span><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">dreamcore</span><span class="hl-0"> </span><span class="hl-5">db:create</span><br/><span class="hl-1">NODE_ENV</span><span class="hl-0">=</span><span class="hl-5">test</span><span class="hl-0"> </span><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">dreamcore</span><span class="hl-0"> </span><span class="hl-5">db:migrate</span>
</code><button type="button">Copy</button></pre>

<a id="md:features" class="tsd-anchor"></a><h2 class="tsd-anchor-link">Features<a href="#md:features" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The dream ORM features:</p>
<ul>
<li>static query building engine</li>
</ul>
<pre><code class="ts"><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">records</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">where</span><span class="hl-0">({ </span><span class="hl-1">email:</span><span class="hl-0"> </span><span class="hl-5">&#39;fred@fred&#39;</span><span class="hl-0"> }).</span><span class="hl-4">all</span><span class="hl-0">()</span><br/><span class="hl-8">// User[]</span><br/><br/><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">user</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">where</span><span class="hl-0">({ </span><span class="hl-1">email:</span><span class="hl-0"> </span><span class="hl-5">&#39;fred@fred&#39;</span><span class="hl-0"> }).</span><span class="hl-4">first</span><span class="hl-0">()</span><br/><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">user</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">where</span><span class="hl-0">({ </span><span class="hl-1">email:</span><span class="hl-0"> </span><span class="hl-5">&#39;fred@fred&#39;</span><span class="hl-0"> }).</span><span class="hl-4">last</span><span class="hl-0">()</span><br/><span class="hl-8">// User | null</span><br/><br/><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">user</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">where</span><span class="hl-0">({ </span><span class="hl-1">email:</span><span class="hl-0"> </span><span class="hl-1">ops</span><span class="hl-0">.</span><span class="hl-4">like</span><span class="hl-0">(</span><span class="hl-5">&#39;%fred@%&#39;</span><span class="hl-0">) })</span><br/><span class="hl-0">  .</span><span class="hl-4">order</span><span class="hl-0">(</span><span class="hl-5">&#39;id&#39;</span><span class="hl-0">, </span><span class="hl-5">&#39;desc&#39;</span><span class="hl-0">)</span><br/><span class="hl-0">  .</span><span class="hl-4">limit</span><span class="hl-0">(</span><span class="hl-3">3</span><span class="hl-0">)</span><br/><span class="hl-0">  .</span><span class="hl-4">all</span><span class="hl-0">()</span><br/><br/><span class="hl-8">// User[]</span>
</code><button type="button">Copy</button></pre>

<ul>
<li>model hooks
<ul>
<li>before create</li>
<li>before update</li>
<li>before delete</li>
<li>before save</li>
<li>after create</li>
<li>after update</li>
<li>after delete</li>
<li>after save</li>
</ul>
</li>
</ul>
<pre><code class="ts"><span class="hl-8">// models/composition.ts</span><br/><br/><span class="hl-6">class</span><span class="hl-0"> </span><span class="hl-9">Composition</span><span class="hl-0"> {</span><br/><span class="hl-0">  ...</span><br/><span class="hl-0">  @</span><span class="hl-4">BeforeCreate</span><span class="hl-0">()</span><br/><span class="hl-0">  </span><span class="hl-6">public</span><span class="hl-0"> </span><span class="hl-4">setDefaultContent</span><span class="hl-0">() {</span><br/><span class="hl-0">    </span><span class="hl-7">if</span><span class="hl-0"> (!</span><span class="hl-6">this</span><span class="hl-0">.</span><span class="hl-1">content</span><span class="hl-0">) </span><span class="hl-6">this</span><span class="hl-0">.</span><span class="hl-1">content</span><span class="hl-0"> = </span><span class="hl-5">&#39;default content&#39;</span><br/><span class="hl-0">  }</span><br/><br/><span class="hl-0">  @</span><span class="hl-4">AfterCreate</span><span class="hl-0">()</span><br/><span class="hl-0">  </span><span class="hl-6">public</span><span class="hl-0"> </span><span class="hl-4">conditionallyChangeContentOnCreate</span><span class="hl-0">() {</span><br/><span class="hl-0">    </span><span class="hl-7">if</span><span class="hl-0"> (</span><span class="hl-6">this</span><span class="hl-0">.</span><span class="hl-1">content</span><span class="hl-0"> === </span><span class="hl-5">&#39;change me after create&#39;</span><span class="hl-0">) </span><span class="hl-6">this</span><span class="hl-0">.</span><span class="hl-1">content</span><span class="hl-0"> = </span><span class="hl-5">&#39;changed after create&#39;</span><br/><span class="hl-0">  }</span><br/><br/><span class="hl-0">  @</span><span class="hl-4">AfterUpdate</span><span class="hl-0">()</span><br/><span class="hl-0">  </span><span class="hl-6">public</span><span class="hl-0"> </span><span class="hl-4">conditionallyChangeContentOnUpdate</span><span class="hl-0">() {</span><br/><span class="hl-0">    </span><span class="hl-7">if</span><span class="hl-0"> (</span><span class="hl-6">this</span><span class="hl-0">.</span><span class="hl-1">content</span><span class="hl-0"> === </span><span class="hl-5">&#39;change me after update&#39;</span><span class="hl-0">) </span><span class="hl-6">this</span><span class="hl-0">.</span><span class="hl-1">content</span><span class="hl-0"> = </span><span class="hl-5">&#39;changed after update&#39;</span><br/><span class="hl-0">  }</span><br/><br/><span class="hl-0">  @</span><span class="hl-4">AfterSave</span><span class="hl-0">()</span><br/><span class="hl-0">  </span><span class="hl-6">public</span><span class="hl-0"> </span><span class="hl-4">conditionallyChangeContentOnSave</span><span class="hl-0">() {</span><br/><span class="hl-0">    </span><span class="hl-7">if</span><span class="hl-0"> (</span><span class="hl-6">this</span><span class="hl-0">.</span><span class="hl-1">content</span><span class="hl-0"> === </span><span class="hl-5">&#39;change me after save&#39;</span><span class="hl-0">) </span><span class="hl-6">this</span><span class="hl-0">.</span><span class="hl-1">content</span><span class="hl-0"> = </span><span class="hl-5">&#39;changed after save&#39;</span><br/><span class="hl-0">  }</span><br/><span class="hl-0">  ...</span><br/><span class="hl-0">}</span>
</code><button type="button">Copy</button></pre>

<ul>
<li>validations
<ul>
<li>presence</li>
<li>length{min, max}</li>
<li>contains{string | regex}</li>
</ul>
</li>
</ul>
<pre><code class="ts"><span class="hl-7">export</span><span class="hl-0"> </span><span class="hl-7">default</span><span class="hl-0"> </span><span class="hl-6">class</span><span class="hl-0"> </span><span class="hl-9">User</span><span class="hl-0"> </span><span class="hl-6">extends</span><span class="hl-0"> </span><span class="hl-9">Dream</span><span class="hl-0"> {</span><br/><span class="hl-0">  ...</span><br/><span class="hl-0">  @</span><span class="hl-4">Validates</span><span class="hl-0">(</span><span class="hl-5">&#39;contains&#39;</span><span class="hl-0">, </span><span class="hl-5">&#39;@&#39;</span><span class="hl-0">)</span><br/><span class="hl-0">  @</span><span class="hl-4">Validates</span><span class="hl-0">(</span><span class="hl-5">&#39;presence&#39;</span><span class="hl-0">)</span><br/><span class="hl-0">  </span><span class="hl-6">public</span><span class="hl-0"> </span><span class="hl-1">email</span><span class="hl-0">: </span><span class="hl-9">string</span><br/><br/><span class="hl-0">  @</span><span class="hl-4">Validates</span><span class="hl-0">(</span><span class="hl-5">&#39;length&#39;</span><span class="hl-0">, { </span><span class="hl-1">min:</span><span class="hl-0"> </span><span class="hl-3">4</span><span class="hl-0">, </span><span class="hl-1">max:</span><span class="hl-0"> </span><span class="hl-3">18</span><span class="hl-0"> })</span><br/><span class="hl-0">  </span><span class="hl-6">public</span><span class="hl-0"> </span><span class="hl-1">password</span><span class="hl-0">: </span><span class="hl-9">string</span><br/><span class="hl-0">  ...</span><br/><span class="hl-0">}</span>
</code><button type="button">Copy</button></pre>

<ul>
<li>
<p>associations</p>
<ul>
<li>belongs to</li>
<li>has one</li>
<li>has many</li>
<li>has one through</li>
<li>has many through</li>
<li>has one through (nested indefinitely)</li>
<li>has many through (nested indefinitely)</li>
</ul>
</li>
</ul>
<pre><code class="ts"><span class="hl-8">// models/user.ts</span><br/><span class="hl-6">class</span><span class="hl-0"> </span><span class="hl-9">User</span><span class="hl-0"> {</span><br/><span class="hl-0">  ...</span><br/><span class="hl-0">  @</span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">HasMany</span><span class="hl-0">(</span><span class="hl-5">&#39;Composition&#39;</span><span class="hl-0">)</span><br/><span class="hl-0">  </span><span class="hl-6">public</span><span class="hl-0"> </span><span class="hl-1">compositions</span><span class="hl-0">: </span><span class="hl-9">Composition</span><span class="hl-0">[]</span><br/><br/><span class="hl-0">  @</span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">HasOne</span><span class="hl-0">(</span><span class="hl-5">&#39;Composition&#39;</span><span class="hl-0">)</span><br/><span class="hl-0">  </span><span class="hl-6">public</span><span class="hl-0"> </span><span class="hl-1">mainComposition</span><span class="hl-0">: </span><span class="hl-9">Composition</span><br/><br/><span class="hl-0">  @</span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">HasMany</span><span class="hl-0">(</span><span class="hl-5">&#39;CompositionAsset&#39;</span><span class="hl-0">, {</span><br/><span class="hl-0">    </span><span class="hl-1">through:</span><span class="hl-0"> </span><span class="hl-5">&#39;compositions&#39;</span><span class="hl-0">,</span><br/><span class="hl-0">  })</span><br/><span class="hl-0">  </span><span class="hl-6">public</span><span class="hl-0"> </span><span class="hl-1">compositionAssets</span><span class="hl-0">: </span><span class="hl-9">CompositionAsset</span><span class="hl-0">[]</span><br/><span class="hl-0">}</span><br/><br/><span class="hl-8">// models/composition.ts</span><br/><span class="hl-7">export</span><span class="hl-0"> </span><span class="hl-7">default</span><span class="hl-0"> </span><span class="hl-6">class</span><span class="hl-0"> </span><span class="hl-9">Composition</span><span class="hl-0"> </span><span class="hl-6">extends</span><span class="hl-0"> </span><span class="hl-9">Dream</span><span class="hl-0"> {</span><br/><span class="hl-0">  ...</span><br/><span class="hl-0">  @</span><span class="hl-1">Composition</span><span class="hl-0">.</span><span class="hl-4">BelongsTo</span><span class="hl-0">(</span><span class="hl-5">&#39;User&#39;</span><span class="hl-0">)</span><br/><span class="hl-0">  </span><span class="hl-6">public</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">: </span><span class="hl-9">User</span><br/><span class="hl-0">}</span><br/><br/><span class="hl-8">// models/composition-asset.ts</span><br/><span class="hl-7">export</span><span class="hl-0"> </span><span class="hl-7">default</span><span class="hl-0"> </span><span class="hl-6">class</span><span class="hl-0"> </span><span class="hl-9">CompositionAsset</span><span class="hl-0"> </span><span class="hl-6">extends</span><span class="hl-0"> </span><span class="hl-9">Dream</span><span class="hl-0"> {</span><br/><span class="hl-0">  ...</span><br/><span class="hl-0">  @</span><span class="hl-1">CompositionAsset</span><span class="hl-0">.</span><span class="hl-4">BelongsTo</span><span class="hl-0">(</span><span class="hl-5">&#39;Composition&#39;</span><span class="hl-0">)</span><br/><span class="hl-0">  </span><span class="hl-6">public</span><span class="hl-0"> </span><span class="hl-1">composition</span><span class="hl-0">: </span><span class="hl-9">Composition</span><br/><span class="hl-0">  ...</span><br/><span class="hl-0">}</span><br/><br/>
</code><button type="button">Copy</button></pre>

<ul>
<li>
<p>scopes</p>
<ul>
<li>named</li>
<li>default</li>
</ul>
</li>
<li>
<p>single table inheritance</p>
</li>
</ul>
<pre><code class="ts"><span class="hl-6">class</span><span class="hl-0"> </span><span class="hl-9">User</span><span class="hl-0"> {</span><br/><span class="hl-0">  @</span><span class="hl-4">Scope</span><span class="hl-0">()</span><br/><span class="hl-0">  </span><span class="hl-6">public</span><span class="hl-0"> </span><span class="hl-6">static</span><span class="hl-0"> </span><span class="hl-4">withFunnyName</span><span class="hl-0">(</span><span class="hl-1">query</span><span class="hl-0">: </span><span class="hl-9">Query</span><span class="hl-0">&lt;</span><span class="hl-9">User</span><span class="hl-0">&gt;) {</span><br/><span class="hl-0">    </span><span class="hl-7">return</span><span class="hl-0"> </span><span class="hl-1">query</span><span class="hl-0">.</span><span class="hl-4">where</span><span class="hl-0">({ </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-5">&#39;Chalupas jr&#39;</span><span class="hl-0"> })</span><br/><span class="hl-0">  }</span><br/><br/><span class="hl-0">  </span><span class="hl-8">// this will always fire whenever queries are run against the model</span><br/><span class="hl-0">  @</span><span class="hl-4">Scope</span><span class="hl-0">({ </span><span class="hl-1">default:</span><span class="hl-0"> </span><span class="hl-6">true</span><span class="hl-0"> })</span><br/><span class="hl-0">  </span><span class="hl-6">public</span><span class="hl-0"> </span><span class="hl-6">static</span><span class="hl-0"> </span><span class="hl-4">hideDeleted</span><span class="hl-0">(</span><span class="hl-1">query</span><span class="hl-0">: </span><span class="hl-9">Query</span><span class="hl-0">&lt;</span><span class="hl-9">User</span><span class="hl-0">&gt;) {</span><br/><span class="hl-0">    </span><span class="hl-7">return</span><span class="hl-0"> </span><span class="hl-1">query</span><span class="hl-0">.</span><span class="hl-4">where</span><span class="hl-0">({ </span><span class="hl-1">deleted_at:</span><span class="hl-0"> </span><span class="hl-6">null</span><span class="hl-0"> })</span><br/><span class="hl-0">  }</span><br/><span class="hl-0">}</span><br/><br/><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">scope</span><span class="hl-0">(</span><span class="hl-5">&#39;withFunnyName&#39;</span><span class="hl-0">)</span><br/><span class="hl-8">// will only return records with the name &quot;Chalupas jr&quot;</span>
</code><button type="button">Copy</button></pre>

<a id="md:repl" class="tsd-anchor"></a><h3 class="tsd-anchor-link">REPL<a href="#md:repl" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>the repl will open a console, exposing access to the test app models that are built into the framework.
this test app is used to run all of our assertions, and is meant to be replaced by an actual app consuming this ORM.</p>
<p>to get into the console, type:</p>
<pre><code class="bash"><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">console</span>
</code><button type="button">Copy</button></pre>

<p>Once inside the repl, you are able to access all the models within the test app. All the classes are automagically imported.</p>
<pre><code class="ts"><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">user</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">create</span><span class="hl-0">({ </span><span class="hl-1">email:</span><span class="hl-0"> </span><span class="hl-5">&#39;hello@there&#39;</span><span class="hl-0">, </span><span class="hl-1">password:</span><span class="hl-0"> </span><span class="hl-5">&#39;howyadoin&#39;</span><span class="hl-0"> })</span><br/><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">email</span><span class="hl-0"> = </span><span class="hl-5">&#39;fred@flinstone&#39;</span><br/><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-4">save</span><span class="hl-0">()</span>
</code><button type="button">Copy</button></pre>

<a id="md:specs" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Specs<a href="#md:specs" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Running specs is very easy, not much to explain here.</p>
<pre><code><span class="hl-1">yarn</span><span class="hl-0"> </span><span class="hl-1">spec</span>
</code><button>Copy</button></pre>

<p>We are using jest under the hood, and have a plugin enabled called <code>jest-plugin-context</code>, which allows us to branch specs out using the <code>context</code> function in place of <code>describe</code>, like so:</p>
<pre><code class="ts"><span class="hl-4">describe</span><span class="hl-0">(</span><span class="hl-5">&#39;Dream#pluck&#39;</span><span class="hl-0">, () </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">  </span><span class="hl-6">let</span><span class="hl-0"> </span><span class="hl-1">user1</span><span class="hl-0">: </span><span class="hl-9">User</span><br/><span class="hl-0">  </span><span class="hl-6">let</span><span class="hl-0"> </span><span class="hl-1">user2</span><span class="hl-0">: </span><span class="hl-9">User</span><br/><span class="hl-0">  </span><span class="hl-4">beforeEach</span><span class="hl-0">(</span><span class="hl-6">async</span><span class="hl-0"> () </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-1">user1</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">create</span><span class="hl-0">({ </span><span class="hl-1">email:</span><span class="hl-0"> </span><span class="hl-5">&#39;fred@frewd&#39;</span><span class="hl-0">, </span><span class="hl-1">password:</span><span class="hl-0"> </span><span class="hl-5">&#39;howyadoin&#39;</span><span class="hl-0"> })</span><br/><span class="hl-0">    </span><span class="hl-1">user2</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">create</span><span class="hl-0">({ </span><span class="hl-1">email:</span><span class="hl-0"> </span><span class="hl-5">&#39;how@yadoin&#39;</span><span class="hl-0">, </span><span class="hl-1">password:</span><span class="hl-0"> </span><span class="hl-5">&#39;howyadoin&#39;</span><span class="hl-0"> })</span><br/><span class="hl-0">  })</span><br/><br/><span class="hl-0">  </span><span class="hl-4">it</span><span class="hl-0">(</span><span class="hl-5">&#39;plucks the specified attributes and returns them as raw data&#39;</span><span class="hl-0">, </span><span class="hl-6">async</span><span class="hl-0"> () </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">records</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">pluck</span><span class="hl-0">(</span><span class="hl-5">&#39;id&#39;</span><span class="hl-0">)</span><br/><span class="hl-0">    </span><span class="hl-4">expect</span><span class="hl-0">(</span><span class="hl-1">records</span><span class="hl-0">).</span><span class="hl-4">toEqual</span><span class="hl-0">([</span><span class="hl-1">user1</span><span class="hl-0">.</span><span class="hl-1">id</span><span class="hl-0">, </span><span class="hl-1">user2</span><span class="hl-0">.</span><span class="hl-1">id</span><span class="hl-0">])</span><br/><span class="hl-0">  })</span><br/><br/><span class="hl-0">  </span><span class="hl-4">context</span><span class="hl-0">(</span><span class="hl-5">&#39;with multiple fields&#39;</span><span class="hl-0">, () </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-4">it</span><span class="hl-0">(</span><span class="hl-5">&#39;should return multi-dimensional array&#39;</span><span class="hl-0">, </span><span class="hl-6">async</span><span class="hl-0"> () </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">      </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">records</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">order</span><span class="hl-0">(</span><span class="hl-5">&#39;id&#39;</span><span class="hl-0">).</span><span class="hl-4">pluck</span><span class="hl-0">(</span><span class="hl-5">&#39;id&#39;</span><span class="hl-0">, </span><span class="hl-5">&#39;createdAt&#39;</span><span class="hl-0">)</span><br/><span class="hl-0">      </span><span class="hl-4">expect</span><span class="hl-0">(</span><span class="hl-1">records</span><span class="hl-0">).</span><span class="hl-4">toEqual</span><span class="hl-0">([</span><br/><span class="hl-0">        [</span><span class="hl-1">user1</span><span class="hl-0">.</span><span class="hl-1">id</span><span class="hl-0">, </span><span class="hl-1">user1</span><span class="hl-0">.</span><span class="hl-1">created_at</span><span class="hl-0">],</span><br/><span class="hl-0">        [</span><span class="hl-1">user2</span><span class="hl-0">.</span><span class="hl-1">id</span><span class="hl-0">, </span><span class="hl-1">user2</span><span class="hl-0">.</span><span class="hl-1">created_at</span><span class="hl-0">],</span><br/><span class="hl-0">      ])</span><br/><span class="hl-0">    })</span><br/><span class="hl-0">  })</span><br/><span class="hl-0">})</span>
</code><button type="button">Copy</button></pre>

<a id="md:cli" class="tsd-anchor"></a><h3 class="tsd-anchor-link">CLI<a href="#md:cli" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="bash"><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">build</span><br/><span class="hl-8"># builds source code using the typescript compiler, sending it into the dist folder</span><br/><br/><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">spec</span><br/><span class="hl-8"># runs core development specs (same as yarn dream spec --core)</span><br/><br/><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">console</span><br/><span class="hl-8"># opens console, providing access to the internal test-app/app/models folder (same as yarn dream console --core)</span><br/><br/><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">dream</span><br/><span class="hl-8"># opens a small node cli program, which right now only provides commands for generating dreams and migrations,</span><br/><span class="hl-8"># but which will likely eventually encompass all of the above commands</span><br/><br/><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">dream</span><span class="hl-0"> </span><span class="hl-5">db:migrate</span><span class="hl-0"> </span><span class="hl-6">--core</span><br/><span class="hl-8"># runs migrations for core development. Use this if you are working on the dream ORM source code.</span><br/><br/><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">dream</span><span class="hl-0"> </span><span class="hl-5">db:migrate</span><br/><span class="hl-8"># runs migrations for an app that is consuming the dream ORM. This is meant to be run from another repo,</span><br/><span class="hl-8"># e.g. within a different app&#39;s package.json:</span><br/><span class="hl-8">#</span><br/><span class="hl-8">#  &quot;scripts&quot;: {</span><br/><span class="hl-8">#     &quot;db:migrate&quot;: &quot;yarn --cwd=node_modules/dream db:migrate&quot;</span><br/><span class="hl-8"># }</span><br/><br/><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">dream</span><span class="hl-0"> </span><span class="hl-5">sync:schema</span><br/><span class="hl-8"># syncs db schema from an app that is consuming the dream ORM. This is necessary, because in order to provide</span><br/><span class="hl-8"># deep integration with kysely, we must actually introspect the schema of your app and provide it</span><br/><span class="hl-8"># as part of the dream orm source code build. It essentially scans your database, examines all tables, outputs interfaces that kysely can consume, puts them into a file, and exports all the interfaces within that file.</span><br/><br/><span class="hl-8"># the sync command is already run as part of the migration sequence, so there should be no need to</span><br/><span class="hl-8"># run it manually. Simply run migrations to have the syncing done for you.</span><br/><br/><span class="hl-8"># A copy of this is output to your app (though don&#39;t bother manually modifying it, since it is blown away each</span><br/><span class="hl-8"># time you run migrations). It is then copied over to the node_modules/dream/src/sync folder, so that importing</span><br/><span class="hl-8"># the dream orm can provide that integration for you.</span><br/><br/><span class="hl-8"># This is meant to be run from another repo,</span><br/><span class="hl-8"># e.g. within a different app&#39;s package.json:</span><br/><span class="hl-8">#</span><br/><span class="hl-8">#  &quot;scripts&quot;: {</span><br/><span class="hl-8">#     &quot;sync:schema&quot;: &quot;yarn --cwd=node_modules/dream sync:schema&quot;</span><br/><span class="hl-8"># }</span><br/><br/><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">dream</span><span class="hl-0"> </span><span class="hl-5">sync:schema</span><span class="hl-0"> </span><span class="hl-6">--core</span><br/><span class="hl-8"># runs the same sync script mentioned above, but for core development. You would run this if you were trying to</span><br/><span class="hl-8"># sync for the test-app, which is used to seed the local tests and provide models for use within the console.</span><br/><span class="hl-8"># Similar to above, a local copy of schema is kept within test-app/db/schema.ts, which is updated each time you</span><br/><span class="hl-8"># run yarn core:db:migrate.</span><br/><br/><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">dream</span><span class="hl-0"> </span><span class="hl-5">sync:associations</span><br/><span class="hl-8"># runs a script which analyzes your models, building a mapping of the associations into typescript interfaces</span><br/><span class="hl-8"># which will assist in providing enforced type completion mechanisms at the code composition level. This must be</span><br/><span class="hl-8"># this is used by the underlying `load` method, as well as `preload` and `joins` methods within the query</span><br/><span class="hl-8"># building layer. This is all copied to the file specified in the `.dream.yml#associations_path`. This is also automatically done whenever you run migrations, run specs, or open a console</span><br/><br/><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">dream</span><span class="hl-0"> </span><span class="hl-5">sync:associations</span><span class="hl-0"> </span><span class="hl-6">--core</span><br/><span class="hl-8"># same as above, but copies the associations.ts file to test-app/db/associations.ts</span><br/><br/><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">dream</span><span class="hl-0"> </span><span class="hl-5">db:drop</span><span class="hl-0"> </span><span class="hl-6">--core</span><br/><span class="hl-8"># drops the db for either the core app or a consuming app (which is why there is no &quot;core:db:drop&quot; variant)</span><br/><br/><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">dream</span><span class="hl-0"> </span><span class="hl-5">db:create</span><span class="hl-0"> </span><span class="hl-6">--core</span><br/><span class="hl-8"># creates the db for either the core app or a consuming app (which is why there is no &quot;core:db:create&quot; variant)</span>
</code><button type="button">Copy</button></pre>

<a id="md:similarity-matching" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Similarity matching<a href="#md:similarity-matching" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Dream provides a similarity searching library out of the box which allows you to implement fuzzy-searching in your app. To use it, first write a migration.</p>
<pre><code class="bash"><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">psy</span><span class="hl-0"> </span><span class="hl-5">g:migration</span><span class="hl-0"> </span><span class="hl-5">add_fuzzy_search_to_users</span>
</code><button type="button">Copy</button></pre>

<p>Open the generated migration, create the pg_trgm extension and create a gin index for a field on your model</p>
<pre><code class="ts"><span class="hl-7">import</span><span class="hl-0"> { </span><span class="hl-1">Kysely</span><span class="hl-0">, </span><span class="hl-1">sql</span><span class="hl-0"> } </span><span class="hl-7">from</span><span class="hl-0"> </span><span class="hl-5">&#39;kysely&#39;</span><br/><span class="hl-7">import</span><span class="hl-0"> { </span><span class="hl-1">createGinIndex</span><span class="hl-0">, </span><span class="hl-1">createExtension</span><span class="hl-0"> } </span><span class="hl-7">from</span><span class="hl-0"> </span><span class="hl-5">&#39;@rvohealth/dream&#39;</span><br/><br/><span class="hl-7">export</span><span class="hl-0"> </span><span class="hl-6">async</span><span class="hl-0"> </span><span class="hl-6">function</span><span class="hl-0"> </span><span class="hl-4">up</span><span class="hl-0">(</span><span class="hl-1">db</span><span class="hl-0">: </span><span class="hl-9">Kysely</span><span class="hl-0">&lt;</span><span class="hl-9">any</span><span class="hl-0">&gt;): </span><span class="hl-9">Promise</span><span class="hl-0">&lt;</span><span class="hl-9">void</span><span class="hl-0">&gt; {</span><br/><span class="hl-0">  </span><span class="hl-8">// this only needs to be run once per db</span><br/><span class="hl-0">  </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-4">createExtension</span><span class="hl-0">(</span><span class="hl-5">&#39;pg_trgm&#39;</span><span class="hl-0">, </span><span class="hl-1">db</span><span class="hl-0">)</span><br/><br/><span class="hl-0">  </span><span class="hl-8">// this is not necessary, but it will dramatically improve the search</span><br/><span class="hl-0">  </span><span class="hl-8">// speed once your db has enough records for it to matter</span><br/><span class="hl-0">  </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-4">createGinIndex</span><span class="hl-0">(</span><span class="hl-5">&#39;users&#39;</span><span class="hl-0">, </span><span class="hl-5">&#39;name&#39;</span><span class="hl-0">, </span><span class="hl-5">&#39;users_name_gin_index&#39;</span><span class="hl-0">, </span><span class="hl-1">db</span><span class="hl-0">)</span><br/><span class="hl-0">}</span><br/><br/><span class="hl-7">export</span><span class="hl-0"> </span><span class="hl-6">async</span><span class="hl-0"> </span><span class="hl-6">function</span><span class="hl-0"> </span><span class="hl-4">down</span><span class="hl-0">(</span><span class="hl-1">db</span><span class="hl-0">: </span><span class="hl-9">Kysely</span><span class="hl-0">&lt;</span><span class="hl-9">any</span><span class="hl-0">&gt;): </span><span class="hl-9">Promise</span><span class="hl-0">&lt;</span><span class="hl-9">void</span><span class="hl-0">&gt; {</span><br/><span class="hl-0">  </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">db</span><span class="hl-0">.</span><span class="hl-1">schema</span><span class="hl-0">.</span><span class="hl-4">dropIndex</span><span class="hl-0">(</span><span class="hl-5">&#39;users_name_gin_index&#39;</span><span class="hl-0">)</span><br/><span class="hl-0">}</span>
</code><button type="button">Copy</button></pre>

<p>Once done, run migrations</p>
<pre><code class="bash"><span class="hl-1">NODE_ENV</span><span class="hl-0">=</span><span class="hl-5">development</span><span class="hl-0"> </span><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">psy</span><span class="hl-0"> </span><span class="hl-5">db:migrate</span>
</code><button type="button">Copy</button></pre>

<p>Now you can take full advantage of pg_trgm using the dream adapters!</p>
<pre><code class="ts"><span class="hl-7">import</span><span class="hl-0"> { </span><span class="hl-1">ops</span><span class="hl-0"> } </span><span class="hl-7">from</span><span class="hl-0"> </span><span class="hl-5">&#39;@rvohealth/dream&#39;</span><br/><br/><span class="hl-8">// applies a score match of 0.3</span><br/><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">users</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">where</span><span class="hl-0">({ </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-1">ops</span><span class="hl-0">.</span><span class="hl-4">similarity</span><span class="hl-0">(</span><span class="hl-5">&#39;steeven hawkins&#39;</span><span class="hl-0">) }).</span><span class="hl-4">all</span><span class="hl-0">()</span><br/><br/><span class="hl-8">// applies a score match of 0.5</span><br/><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">users</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">where</span><span class="hl-0">({ </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-1">ops</span><span class="hl-0">.</span><span class="hl-4">wordSimilarity</span><span class="hl-0">(</span><span class="hl-5">&#39;steeven hawkins&#39;</span><span class="hl-0">) }).</span><span class="hl-4">all</span><span class="hl-0">()</span><br/><br/><span class="hl-8">// applies a score match of 0.6</span><br/><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">users</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">where</span><span class="hl-0">({ </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-1">ops</span><span class="hl-0">.</span><span class="hl-4">strictWordSimilarity</span><span class="hl-0">(</span><span class="hl-5">&#39;steeven hawkins&#39;</span><span class="hl-0">) }).</span><span class="hl-4">all</span><span class="hl-0">()</span><br/><br/><span class="hl-8">// applies a score match of 0.2</span><br/><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">users</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">where</span><span class="hl-0">({ </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-1">ops</span><span class="hl-0">.</span><span class="hl-4">similarity</span><span class="hl-0">(</span><span class="hl-5">&#39;steeven hawkins&#39;</span><span class="hl-0">, { </span><span class="hl-1">score:</span><span class="hl-0"> </span><span class="hl-3">0.2</span><span class="hl-0"> }) }).</span><span class="hl-4">all</span><span class="hl-0">()</span><br/><br/><span class="hl-8">// this will also work for plucking, updating, joining, and aggregate functions like min, max and count</span><br/><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">userIds</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">where</span><span class="hl-0">({ </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-1">ops</span><span class="hl-0">.</span><span class="hl-4">similarity</span><span class="hl-0">(</span><span class="hl-5">&#39;steeven hawkins&#39;</span><span class="hl-0">) }).</span><span class="hl-4">pluck</span><span class="hl-0">(</span><span class="hl-5">&#39;id&#39;</span><span class="hl-0">)</span><br/><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">min</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">where</span><span class="hl-0">({ </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-1">ops</span><span class="hl-0">.</span><span class="hl-4">similarity</span><span class="hl-0">(</span><span class="hl-5">&#39;steeven hawkins&#39;</span><span class="hl-0">) }).</span><span class="hl-4">min</span><span class="hl-0">(</span><span class="hl-5">&#39;id&#39;</span><span class="hl-0">)</span><br/><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">max</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">where</span><span class="hl-0">({ </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-1">ops</span><span class="hl-0">.</span><span class="hl-4">similarity</span><span class="hl-0">(</span><span class="hl-5">&#39;steeven hawkins&#39;</span><span class="hl-0">) }).</span><span class="hl-4">max</span><span class="hl-0">(</span><span class="hl-5">&#39;id&#39;</span><span class="hl-0">)</span><br/><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">count</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">where</span><span class="hl-0">({ </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-1">ops</span><span class="hl-0">.</span><span class="hl-4">similarity</span><span class="hl-0">(</span><span class="hl-5">&#39;steeven hawkins&#39;</span><span class="hl-0">) }).</span><span class="hl-4">count</span><span class="hl-0">()</span><br/><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">petIds</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">pluckThrough</span><span class="hl-0">(</span><span class="hl-5">&#39;pets&#39;</span><span class="hl-0">, { </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-1">ops</span><span class="hl-0">.</span><span class="hl-4">similarity</span><span class="hl-0">(</span><span class="hl-5">&#39;fido&#39;</span><span class="hl-0">) }, [</span><span class="hl-5">&#39;pets.id&#39;</span><span class="hl-0">])</span><br/><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">numUpdatedRecords</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">where</span><span class="hl-0">({ </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-1">ops</span><span class="hl-0">.</span><span class="hl-4">similarity</span><span class="hl-0">(</span><span class="hl-5">&#39;steeven hawkins&#39;</span><span class="hl-0">) }).</span><span class="hl-4">update</span><span class="hl-0">({</span><br/><span class="hl-0">  </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-5">&#39;Stephen Hawking&#39;</span><span class="hl-0">,</span><br/><span class="hl-0">})</span><br/><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">users</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">joins</span><span class="hl-0">(</span><span class="hl-5">&#39;pets&#39;</span><span class="hl-0">, { </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-1">ops</span><span class="hl-0">.</span><span class="hl-4">similarity</span><span class="hl-0">(</span><span class="hl-5">&#39;fido&#39;</span><span class="hl-0">) }).</span><span class="hl-4">all</span><span class="hl-0">()</span><br/><br/><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">user</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-4">first</span><span class="hl-0">()</span><br/><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-2">pets</span><span class="hl-0"> = </span><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">user</span><br/><span class="hl-0">  .</span><span class="hl-4">associationQuery</span><span class="hl-0">(</span><span class="hl-5">&#39;pets&#39;</span><span class="hl-0">)</span><br/><span class="hl-0">  .</span><span class="hl-4">where</span><span class="hl-0">({ </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-1">ops</span><span class="hl-0">.</span><span class="hl-4">similarity</span><span class="hl-0">(</span><span class="hl-5">&#39;fido&#39;</span><span class="hl-0">) })</span><br/><span class="hl-0">  .</span><span class="hl-4">all</span><span class="hl-0">()</span>
</code><button type="button">Copy</button></pre>

<a id="md:contributing" class="tsd-anchor"></a><h3 class="tsd-anchor-link">Contributing<a href="#md:contributing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Though the spec framework isn't entirely comprehensive, this application was built with a BDD philosophy guiding its foundation, using tests that actually excercize the ORM from front to back, rather than relying on lot's of stubbing of internal modules.</p>
<p>Though the specs are not technically unit tests in the traditional sense, they are all located under <code>spec/unit</code>, and resemble unit tests in their file structure, since there is generally a file for each method on a class. If you are contributing to this project, it will probably in the form of either adding or augmenting the functionality of existing methods, so it should be relatively easy to jump in and not make a mess. If you are adding a new method, you should be adding a new file for it. If it is new behavior on an existing method, you can add context blocks within that method spec file to expand on the behavior of that method. Static and instance methods with the same name should be in the same file, but contextualized differently, though this should rarely happen.</p>
<p>I am not writing tests for internal functions for the most part, though if you find yourself writing something particularly complex, feel free to find a home in the <code>spec/unit</code> folder somewhere for it (probably in the <code>spec/unit/helpers</code> folder, since that is where I will put specs for helpers I have written when I feel the need to test them).</p>
<p>In terms of setup, you will need to run a few commands to get the environment set up. The commands are the same as those used when you are developing in a real dream app, but you have to pass the <code>--core</code> suffix to get the correct behavior. After installing dream on your machine, you will need to first set up a .env and .env.test file (same as in a real dream app), and you will need to make sure to add an extra flag called <code>DREAM_CORE_DEVELOPMENT</code>, setting it to <code>1</code>.</p>
<pre><code><span class="hl-2">DREAM_CORE_DEVELOPMENT</span><span class="hl-0">=</span><span class="hl-3">1</span><br/><span class="hl-2">DB_USER</span><span class="hl-0">=</span><span class="hl-2">YOUR_LOCAL_DB_USERNAME</span><br/><span class="hl-2">DB_NAME</span><span class="hl-0">=</span><span class="hl-1">dream_core_dev</span><br/><span class="hl-2">DB_PORT</span><span class="hl-0">=</span><span class="hl-3">5432</span><br/><span class="hl-2">DB_HOST</span><span class="hl-0">=</span><span class="hl-1">localhost</span>
</code><button>Copy</button></pre>

<p>Once done, you can run the following commands to get up and running:</p>
<pre><code class="bash"><span class="hl-4">psy</span><span class="hl-0"> </span><span class="hl-5">db:create</span><span class="hl-0"> </span><span class="hl-6">--core</span><br/><span class="hl-1">NODE_ENV</span><span class="hl-0">=</span><span class="hl-5">test</span><span class="hl-0"> </span><span class="hl-4">psy</span><span class="hl-0"> </span><span class="hl-5">db:create</span><span class="hl-0"> </span><span class="hl-6">--core</span><br/><br/><span class="hl-4">psy</span><span class="hl-0"> </span><span class="hl-5">db:migrate</span><span class="hl-0"> </span><span class="hl-6">--core</span><br/><span class="hl-1">NODE_ENV</span><span class="hl-0">=</span><span class="hl-5">test</span><span class="hl-0"> </span><span class="hl-4">psy</span><span class="hl-0"> </span><span class="hl-5">db:migrate</span><span class="hl-0"> </span><span class="hl-6">--core</span>
</code><button type="button">Copy</button></pre>

<a id="md:generating-type-docs" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Generating type docs:<a href="#md:generating-type-docs" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="bash"><span class="hl-8"># first, you will need to update package.json version, in order to keep</span><br/><span class="hl-8"># docs generated on a per-version basis</span><br/><span class="hl-4">yarn</span><span class="hl-0"> </span><span class="hl-5">build:docs</span>
</code><button type="button">Copy</button></pre>

<a id="md:hidden-gotchas" class="tsd-anchor"></a><h4 class="tsd-anchor-link">Hidden gotchas<a href="#md:hidden-gotchas" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><ul>
<li>STI descendants of the same root model that define the same association must define that association identically if they are used in joins, preload, or load. For example, the following will not work properly:</li>
</ul>
<pre><code class="ts"><span class="hl-0">@</span><span class="hl-4">STI</span><span class="hl-0">(</span><span class="hl-2">A</span><span class="hl-0">)</span><br/><span class="hl-6">class</span><span class="hl-0"> </span><span class="hl-9">B</span><span class="hl-0"> </span><span class="hl-6">extends</span><span class="hl-0"> </span><span class="hl-9">A</span><span class="hl-0"> {</span><br/><span class="hl-0">  @</span><span class="hl-2">B</span><span class="hl-0">.</span><span class="hl-4">HasMany</span><span class="hl-0">(</span><span class="hl-5">&#39;X&#39;</span><span class="hl-0">)</span><br/><span class="hl-0">  </span><span class="hl-6">public</span><span class="hl-0"> </span><span class="hl-1">xx</span><span class="hl-0">: </span><span class="hl-9">X</span><span class="hl-0">[]</span><br/><span class="hl-0">}</span><br/><br/><span class="hl-0">@</span><span class="hl-4">STI</span><span class="hl-0">(</span><span class="hl-2">A</span><span class="hl-0">)</span><br/><span class="hl-6">class</span><span class="hl-0"> </span><span class="hl-9">C</span><span class="hl-0"> </span><span class="hl-6">extends</span><span class="hl-0"> </span><span class="hl-9">A</span><span class="hl-0"> {</span><br/><span class="hl-0">  @</span><span class="hl-2">C</span><span class="hl-0">.</span><span class="hl-4">HasMany</span><span class="hl-0">(</span><span class="hl-5">&#39;X&#39;</span><span class="hl-0">, { </span><span class="hl-1">where:</span><span class="hl-0"> { </span><span class="hl-1">something:</span><span class="hl-0"> </span><span class="hl-6">true</span><span class="hl-0"> } })</span><br/><span class="hl-0">  </span><span class="hl-6">public</span><span class="hl-0"> </span><span class="hl-1">xx</span><span class="hl-0">: </span><span class="hl-9">X</span><span class="hl-0">[]</span><br/><span class="hl-0">}</span><br/><br/><span class="hl-6">class</span><span class="hl-0"> </span><span class="hl-9">Z</span><span class="hl-0"> </span><span class="hl-6">extends</span><span class="hl-0"> </span><span class="hl-9">Dream</span><span class="hl-0"> {</span><br/><span class="hl-0">  @</span><span class="hl-2">Z</span><span class="hl-0">.</span><span class="hl-4">HasMany</span><span class="hl-0">(</span><span class="hl-5">&#39;A&#39;</span><span class="hl-0">)</span><br/><span class="hl-0">  </span><span class="hl-6">public</span><span class="hl-0"> </span><span class="hl-1">aa</span><span class="hl-0">: </span><span class="hl-9">A</span><span class="hl-0">[]</span><br/><span class="hl-0">}</span><br/><br/><span class="hl-8">// this will not work as expected because the HasMany(&#39;X&#39;) are defined differently</span><br/><span class="hl-7">await</span><span class="hl-0"> </span><span class="hl-1">z</span><span class="hl-0">.</span><span class="hl-4">load</span><span class="hl-0">({ </span><span class="hl-1">aa:</span><span class="hl-0"> </span><span class="hl-5">&#39;xx&#39;</span><span class="hl-0"> }).</span><span class="hl-4">execute</span><span class="hl-0">()</span>
</code><button type="button">Copy</button></pre>

</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#md:dream-orm"><span>dream ORM</span></a><ul><li><a href="#md:getting-started"><span>Getting started</span></a></li><li><ul><li><a href="#md:install-nodenv"><span>Install nodenv</span></a></li><li><a href="#md:add-env-files"><span>Add ENV files</span></a></li><li><a href="#md:build-db-and-sync-schema"><span>Build db and sync schema</span></a></li></ul></li><li><a href="#md:features"><span>Features</span></a></li><li><ul><li><a href="#md:repl"><span>REPL</span></a></li><li><a href="#md:specs"><span>Specs</span></a></li><li><a href="#md:cli"><span>CLI</span></a></li><li><a href="#md:similarity-matching"><span>Similarity matching</span></a></li><li><a href="#md:contributing"><span>Contributing</span></a></li><li><ul><li><a href="#md:generating-type-docs"><span>Generating type docs:</span></a></li><li><a href="#md:hidden-gotchas"><span>Hidden gotchas</span></a></li></ul></li></ul></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="modules.html" class="current"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="assets/icons.svg#icon-1"></use></svg><span>@rvohealth/dream</span></a><ul class="tsd-small-nested-navigation" id="tsd-nav-container" data-base="."><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
